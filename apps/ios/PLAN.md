# ChapterCheck Native iOS App — Implementation Plan

## Context

The Expo/React Native mobile app is janky and not up to quality standards. We're building a native SwiftUI iOS app focused 100% on consumption: sign in, browse books, and listen. No CRUD, no sign-up — existing users only. The app connects to the same Convex backend the web app uses.

**Key decisions:**

- Auth: Clerk email + OTP code (no sign-up, no Apple sign-in)
- Streaming only (no offline/downloads for V1)
- Location: `apps/ios/` in the existing monorepo
- iOS 17+ minimum (for `@Observable`, modern SwiftUI)
- Two tabs: Home + Library
- Persistent mini player + full-screen Now Playing

**SPM Dependencies:**

- `https://github.com/get-convex/convex-swift` (ConvexMobile 0.7.0)
- `https://github.com/clerk/clerk-ios` (ClerkKit 1.0.0)

---

## Status

- [x] Phase 1: Project Setup
- [x] Phase 2: Authentication
- [x] Phase 3: Core Data Layer
- [x] Phase 4: Home Screen
- [x] Phase 5: Library & Browse
- [x] Phase 6: Book Detail, Author Detail, Series Detail
- [x] Phase 7: Audio Player
- [x] Phase 8: Polish (basic loading/error/empty states)
- [x] Bug fixes: Auth race condition, Int/Float64 type mismatch, BookAuthor model decoding

**Current state:** All 8 phases scaffolded (~73 files). Auth works end-to-end. Home tab loads real data from Convex (recently listening, recent books, top rated, stats). Library tab, book detail, and audio player views are built but not yet verified on device.

---

## Architecture

### File Structure

```
apps/ios/
  .gitignore
  project.yml                    — XcodeGen project spec
  ChapterCheck.xcodeproj/        — Generated by XcodeGen
  ChapterCheck/
    App/
      ChapterCheckApp.swift      — @main, Clerk.configure()
    Config/
      Environment.swift          — #if DEBUG dev/prod switching
    Auth/
      ClerkConvexAuthProvider.swift — AuthProvider<String> for ConvexClientWithAuth
      SignInView.swift            — Email → OTP two-step sign-in
      AuthGateView.swift          — Gates on Clerk session + Convex auth state
    Services/
      ConvexService.swift         — Singleton: ConvexClientWithAuth, subscribe/mutation/action helpers
    Models/
      Book.swift                  — BookWithDetails, BookAuthor, SeriesSummary
      Author.swift                — Author, AuthorWithCounts, AuthorBook, AuthorSeries
      Series.swift
      AudioFile.swift
      ListeningProgress.swift     — ListeningProgress, RecentListeningProgress
      HomeStats.swift
      User.swift
      BookUserData.swift          — BookUserData, PublicReview, RatingStats
      Review.swift
      PaginatedResult.swift       — Generic paginated response wrapper
    Repositories/
      BookRepository.swift        — Convex book queries (subscribe + pagination)
      AuthorRepository.swift
      AudioRepository.swift       — Audio file queries + generateStreamUrl action
      ProgressRepository.swift    — Listening progress queries + saveProgress mutation
      UserRepository.swift
      BookUserDataRepository.swift
      ImageRepository.swift       — Presigned R2 image URL cache (~50min TTL)
      SeriesRepository.swift
    Audio/
      AudioPlayerManager.swift    — Central @Observable: AVPlayer, play/pause/seek/skip/rate, progress saving
      AudioSessionManager.swift   — AVAudioSession .playback + .spokenAudio
      NowPlayingManager.swift     — MPNowPlayingInfoCenter + MPRemoteCommandCenter
      StreamURLCache.swift        — Actor caching presigned audio URLs (~50min TTL)
    Features/
      Home/
        HomeView.swift            — ScrollView: greeting, stats, sections
        HomeViewModel.swift       — 4 concurrent Convex subscriptions
        ContinueListeningSection.swift — Hero card + horizontal scroll
        HeroListeningCard.swift
        ListeningCard.swift
        BookRowSection.swift      — Horizontal book row (reused)
        HomeBookCard.swift
      Library/
        LibraryView.swift         — LazyVGrid with .searchable + sort
        LibraryViewModel.swift    — Paginated + debounced search
        BookGridCard.swift
        SortPicker.swift
      BookDetail/
        BookDetailView.swift      — Cover + metadata + audio files + reviews
        BookDetailViewModel.swift — 6 concurrent subscriptions
        AudioFileListView.swift
        AudioFileRow.swift
        BookMetadataView.swift
        ReviewsListView.swift
        ReviewRow.swift
      AuthorDetail/
        AuthorDetailView.swift
        AuthorDetailViewModel.swift
      SeriesDetail/
        SeriesDetailView.swift
        SeriesDetailViewModel.swift
      Player/
        MiniPlayerView.swift      — Persistent bar above tab bar
        NowPlayingView.swift      — Full-screen sheet
        SeekBarView.swift
        SpeedControlView.swift
        PartSelectorView.swift
      Shared/
        BookCoverView.swift       — Async image from R2 with placeholder
        LoadingView.swift
        SkeletonView.swift
        EmptyStateView.swift
        ErrorView.swift
    Navigation/
      MainTabView.swift           — TabView (Home + Library) + MiniPlayer overlay + NavigationStack
    Utilities/
      Haptics.swift
      TimeFormatting.swift
    Assets.xcassets/
    Info.plist
```

### Key Patterns

- **Auth flow:** Clerk session → ClerkConvexAuthProvider gets JWT → ConvexClientWithAuth authenticates → AuthGateView shows MainTabView only when `.authenticated`
- **Data layer:** Repository → ConvexService.subscribe() → Combine publisher → ViewModel sink → @Observable state → SwiftUI view
- **Token refresh:** Background Task refreshes Clerk JWT every 50s via `loginFromCache()`
- **Image loading:** R2 key → ImageRepository presigned URL cache → AsyncImage
- **Audio streaming:** AudioFile → StreamURLCache presigned URL → AVPlayer
- **Navigation:** NavigationStack with `AppDestination` enum → `.navigationDestination(for:)` routing

### ConvexMobile Gotchas

- **Int vs Float64:** Convex `v.number()` expects float64. Always pass `Double(intValue)` for numeric args.
- **Model flexibility:** Different queries return different shapes for the same entity. Make non-essential Decodable fields optional.
- **Auth timing:** Must wait for `.authenticated` state before showing views that subscribe to queries.
- **Convex function format:** `"books/queries:listBooks"`, `"audioFiles/actions:generateStreamUrl"`

---

## Remaining Work

### Verification & Testing

- [ ] Verify Library tab loads and paginates correctly
- [ ] Verify Book Detail loads all sections (book info, audio files, progress, reviews)
- [ ] Verify Author Detail and Series Detail screens
- [ ] Test audio streaming on physical device (background audio, lock screen controls)
- [ ] Test progress saving (10s interval, pause, background, rate change)
- [ ] Test multi-part auto-advance
- [ ] Test sign-out and re-sign-in flows
- [ ] Test cold start with cached session

### Polish

- [ ] Replace skeleton shimmer placeholders with real loading states
- [ ] Verify dark mode looks good throughout
- [ ] Add haptic feedback (light on skip/speed, medium on play/pause)
- [ ] Test Dynamic Type and VoiceOver accessibility
- [ ] Verify memory: subscriptions cancel on disappear, no AVPlayer leaks
- [ ] Cover image loading fallback when R2 key is nil

### Build & Distribution

- [ ] Add app icon to Assets.xcassets
- [ ] Configure signing for TestFlight
- [ ] CI: add Xcode build step to GitHub Actions
