# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ChapterCheck is a personal audiobook library management application built with Next.js 15, Convex (real-time backend), and Clerk authentication. It features full-text search, author/series organization, and an integrated audio player with multi-part book support.

## Development Commands

```bash
# Start development (run both in parallel)
npm run dev           # Next.js dev server (port 3000)
npx convex dev        # Convex backend (separate terminal)

# Quality checks
npm run lint          # ESLint (--max-warnings=0)
npm run type-check    # TypeScript strict mode
npm run format:check  # Prettier check

# Testing
npm run test          # Vitest watch mode
npm run test:run      # Single run (CI)

# Convex
npx convex codegen    # Regenerate types after schema changes
npx convex deploy     # Deploy backend to production

# Deployment
npm run cf-deploy     # Build and deploy to Cloudflare Workers
```

## Architecture

### Tech Stack

- **Frontend:** Next.js 15 (App Router), React 19, TypeScript, Tailwind CSS
- **Backend:** Convex (real-time database & serverless functions)
- **Auth:** Clerk (synced to Convex via webhooks)
- **Storage:** Cloudflare R2 (user-partitioned paths)
- **UI:** shadcn/ui + Radix UI primitives
- **Deployment:** Cloudflare Workers + Pages via OpenNext.js

### Key Directories

- `app/` - Next.js App Router pages and layouts
- `components/` - React components organized by feature (audio/, books/, authors/, ui/)
- `convex/` - Backend schema, queries, mutations, and actions
- `hooks/` - Custom React hooks (audio playback, uploads, pagination, etc.)
- `lib/validations/` - Zod schemas for form validation
- `contexts/` - React Context providers (AudioPlayerContext)

### Data Flow

- Convex provides real-time data via `useQuery()` hooks
- Mutations through `useMutation()` trigger automatic UI updates
- Clerk auth state synced to Convex `users` table via webhook
- R2 files accessed via signed URLs generated by Convex actions

### Database Schema (convex/schema.ts)

7 tables: `users`, `books`, `authors`, `series`, `bookAuthors` (many-to-many with roles), `audioFiles`, `storageAccounts`

Key features:

- Full-text search indexes on name/title fields
- Series ordering supports decimals (e.g., 2.5 for novellas)
- Storage accounts isolate R2 paths per user

### Audio Player

Global state in `AudioPlayerContext` handles playback across the app. Supports multi-part books, playback rate persistence, and both mini (fixed bottom) and expanded player views.

## Code Conventions

- **Strict TypeScript:** No `any` types, all files use `.ts`/`.tsx`
- **Import sorting:** Automatic via eslint-plugin-simple-import-sort
- **Styling:** Tailwind CSS only, use `cn()` from `lib/utils` for conditional classes
- **Components:** Use shadcn/ui components from `components/ui/`
- **Forms:** React Hook Form + Zod validation schemas from `lib/validations/`

## Pre-commit Hooks (Lefthook)

Runs in parallel on commit:

1. Prettier format check
2. ESLint validation
3. Convex codegen + TypeScript type check

## Environment Variables

Copy `.env.example` to `.env.local`. Required:

- `CONVEX_DEPLOYMENT`, `NEXT_PUBLIC_CONVEX_URL`
- Clerk keys (`NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY`)
- R2 credentials (`R2_ACCOUNT_ID`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`, etc.)
