# CI/CD Pipeline for ChapterCheck
name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # â”€â”€â”€ Change Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      mobile: ${{ steps.filter.outputs.mobile }}
      backend: ${{ steps.filter.outputs.backend }}
      shared: ${{ steps.filter.outputs.shared }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
            mobile:
              - 'apps/mobile/**'
            backend:
              - 'packages/convex-backend/**'
            shared:
              - 'packages/shared/**'
              - 'packages/tailwind-config/**'
            ci:
              - '.github/workflows/**'

  # â”€â”€â”€ Web Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality:
    name: âœ¨ Code Quality
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'workflow_dispatch' || needs.changes.outputs.web == 'true' || needs.changes.outputs.shared == 'true' || needs.changes.outputs.backend == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Enable Corepack
        run: corepack enable

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ¨ Check formatting
        run: yarn format:check

      - name: ğŸ” Run ESLint
        run: yarn lint

      - name: ğŸ”· TypeScript check
        run: yarn type-check

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [changes, quality]
    if: github.event_name == 'workflow_dispatch' || needs.changes.outputs.web == 'true' || needs.changes.outputs.shared == 'true' || needs.changes.outputs.backend == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Enable Corepack
        run: corepack enable

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ”¨ Build application
        run: yarn build
        env:
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}

  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    needs: [changes, quality]
    if: github.event_name == 'workflow_dispatch' || needs.changes.outputs.web == 'true' || needs.changes.outputs.shared == 'true' || needs.changes.outputs.backend == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Enable Corepack
        run: corepack enable

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ§ª Run tests
        run: yarn test:run

  e2e:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, quality]
    if: github.event_name == 'workflow_dispatch' || needs.changes.outputs.web == 'true' || needs.changes.outputs.shared == 'true' || needs.changes.outputs.backend == 'true' || needs.changes.outputs.ci == 'true'
    env:
      NEXT_PUBLIC_CONVEX_URL: ${{ secrets.E2E_CONVEX_URL }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.E2E_CLERK_PUBLISHABLE_KEY }}
      CLERK_SECRET_KEY: ${{ secrets.E2E_CLERK_SECRET_KEY }}
      E2E_CLERK_USER_EMAIL: ${{ secrets.E2E_CLERK_USER_EMAIL }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Enable Corepack
        run: corepack enable

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ­ Install Playwright Chromium
        run: npx playwright install chromium

      - name: ğŸ—„ï¸ Deploy Convex functions
        run: npx convex deploy
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.E2E_CONVEX_DEPLOY_KEY }}

      - name: ğŸŒ± Seed test data
        run: yarn seed:e2e

      - name: ğŸ§ª Run E2E tests
        run: yarn e2e

      - name: ğŸ“Š Upload Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 14

  deploy:
    name: ğŸš€ Deploy
    needs: [changes, quality, build, test, e2e]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'workflow_dispatch' || github.event_name == 'push') && (github.event_name == 'workflow_dispatch' || needs.changes.outputs.web == 'true' || needs.changes.outputs.shared == 'true' || needs.changes.outputs.backend == 'true' || needs.changes.outputs.ci == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Enable Corepack
        run: corepack enable

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ—„ï¸ Deploy Convex
        run: npx convex deploy
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: ğŸ” Set Cloudflare secrets
        working-directory: apps/web
        run: |
          echo "$CLERK_SECRET_KEY" | npx wrangler secret put CLERK_SECRET_KEY --name chaptercheck
          echo "$R2_ACCOUNT_ID" | npx wrangler secret put R2_ACCOUNT_ID --name chaptercheck
          echo "$R2_TOKEN_VALUE" | npx wrangler secret put R2_TOKEN_VALUE --name chaptercheck
          echo "$R2_ACCESS_KEY_ID" | npx wrangler secret put R2_ACCESS_KEY_ID --name chaptercheck
          echo "$R2_SECRET_ACCESS_KEY" | npx wrangler secret put R2_SECRET_ACCESS_KEY --name chaptercheck
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_TOKEN_VALUE: ${{ secrets.R2_TOKEN_VALUE }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

      - name: ğŸ• Set deploy timestamp
        id: timestamp
        run: echo "deploy_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: â˜ï¸ Deploy to Cloudflare
        run: yarn cf-deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_GIT_HASH: ${{ github.sha }}
          NEXT_PUBLIC_DEPLOY_DATE: ${{ steps.timestamp.outputs.deploy_date }}

      - name: ğŸ‰ Deployment complete
        run: echo "Successfully deployed to production!"

  # â”€â”€â”€ Mobile Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  mobile-quality:
    name: ğŸ“± Mobile Quality
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.mobile == 'true' || needs.changes.outputs.shared == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Enable Corepack
        run: corepack enable

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ”· TypeScript check
        run: yarn workspace @chaptercheck/mobile type-check
